<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Whot Game: Single & Multiplayer</title>
<style>
body { font-family:'Segoe UI', sans-serif; margin:0; padding:0; background:linear-gradient(to bottom, #0b3d91, #1e3c72); color:#fff; text-align:center; }
#modeSelect, #setup, #lobby, #game { margin-top:20px; }
.hand, .discard { display:flex; justify-content:center; margin:10px 0; flex-wrap:wrap; min-height:150px; }
.card { width:100px; height:140px; margin:5px; border-radius:10px; background:white; color:black; display:flex; flex-direction:column; justify-content:space-between; align-items:center; font-weight:bold; font-size:22px; cursor:pointer; box-shadow:0 5px 10px rgba(0,0,0,0.5); transition:transform 0.3s; position:relative; }
.card:hover { transform: scale(1.2); z-index:10; }
.card.red { color:red; } .card.blue { color:blue; } .card.green { color:green; } .card.yellow { color:orange; } .card.black { color:black; }
.card .top-left, .card .bottom-right { position:absolute; font-size:18px; font-weight:bold; }
.card .top-left { top:5px; left:5px; } .card .bottom-right { bottom:5px; right:5px; transform: rotate(180deg); }
.discard .card { cursor: default; transform:none; }
#playerHand { justify-content:center; }
#playersList { list-style:none; padding:0; }
#countdownOverlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); color:#fff; font-size:80px; display:flex; align-items:center; justify-content:center; z-index:9999; }
</style>
</head>
<body>
<h1>Whot Game</h1>

<div id="modeSelect">
  <button id="singleBtn">Single Player</button>
  <button id="multiBtn">Multiplayer</button>
</div>

<div id="setup" style="display:none;">
  <input type="text" id="playerName" placeholder="Enter Your Name">
  <button id="hostBtn">Host Game</button>
  <input type="text" id="peerIdInput" placeholder="Enter Host Code">
  <button id="connectBtn">Join Game</button>
  <p>Your Peer ID: <span id="myId">...</span></p>
</div>

<div id="lobby" style="display:none;">
  <h2>Lobby</h2>
  <p>Share this code to join: <span id="gameCode"></span></p>
  <ul id="playersList"></ul>
  <p id="waitingMsg" style="color:yellow;"></p>
  <button id="startGameBtn">Start Game (Host Only)</button>
</div>

<div id="game" style="display:none;">
  <h2>Discard Pile</h2>
  <div style="display:flex; justify-content:center; align-items:center;">
    <div id="discard" class="discard" ondrop="dropCard(event)" ondragover="allowDrop(event)"></div>
    <div id="drawPile" onclick="drawCard(playerHand)"></div>
  </div>

  <h2>Your Hand</h2>
  <div id="playerHand" class="hand"></div>
  
  <div class="card-counts">
    <p>Your Cards: <span id="playerCount">0</span></p>
  </div>

  <p id="turnInfo"></p>
</div>

<script src="https://cdn.jsdelivr.net/npm/peerjs@1.4.7/dist/peerjs.min.js"></script>
<script>
let deck=[], discardPile=[], playerHand=[], players=[], currentPlayerIndex=0;
let isHost=false, myId=null, connections=[], multiplayer=false;
const suits=['circle','star','cross','triangle'], numbers=[1,2,3,4,5,7,8,10,11,12,13];

// Mode selection
document.getElementById('singleBtn').onclick=()=>{
  multiplayer=false; document.getElementById('modeSelect').style.display='none';
  document.getElementById('game').style.display='block'; startSinglePlayer();
};
document.getElementById('multiBtn').onclick=()=>{
  multiplayer=true; document.getElementById('modeSelect').style.display='none';
  document.getElementById('setup').style.display='block'; initPeer();
};

// PeerJS init
let peer;
function initPeer(){
  peer = new Peer();
  peer.on('open', id => {
    myId = id;
    document.getElementById('myId').innerText = id;
  });

  // Accept incoming connections
  peer.on('connection', conn => {
    connections.push(conn);
    conn.on('data', handleData);
    conn.on('open', () => {
      if(isHost){
        // Send current lobby info to newly connected client
        conn.send({action:'joined', players:players.map(p=>({id:p.id,name:p.name}))});
      }
    });
  });
}

// Handle messages
function handleData(data){
  switch(data.action){
    case 'join':
      if(isHost){
        const conn = connections.find(c=>c.peer===data.playerId);
        players.push({id:data.playerId, name:data.name, hand:[], conn});
        updateLobby();
        // Tell new client that joined
        if(conn) conn.send({action:'joined', players:players.map(p=>({id:p.id,name:p.name}))});
      }
      break;
    case 'joined':
      players = data.players.map(p=>({...p, hand:[]})); updateLobby();
      document.getElementById('waitingMsg').innerText = "Waiting for host to start the game...";
      break;
    case 'start':
      startMultiplayerGame(data);
      break;
    case 'playCard':
      discardPile.push(data.card);
      const p = players.find(pl=>pl.id===data.playerId);
      if(p) p.hand = data.updatedHand;
      currentPlayerIndex = data.nextPlayerIndex;
      renderHands(); updateTurnInfo(); checkWinner();
      break;
    case 'drawCard':
      const player = players.find(pl=>pl.id===data.playerId);
      if(player) player.hand = data.updatedHand;
      deck = data.deck;
      renderHands(); updateTurnInfo();
      break;
  }
}

// Host
document.getElementById('hostBtn').onclick = () => {
  const name = document.getElementById('playerName').value || 'Host';
  isHost = true;
  players = [{id: myId,name,hand:[]}];
  document.getElementById('setup').style.display='none';
  document.getElementById('lobby').style.display='block';
  document.getElementById('gameCode').innerText = myId;
};

// Join
document.getElementById('connectBtn').onclick = () => {
  const hostId = document.getElementById('peerIdInput').value;
  if(!hostId) return alert("Enter host code");
  const name = document.getElementById('playerName').value || 'Player';
  const conn = peer.connect(hostId);
  conn.on('open', ()=>conn.send({action:'join', playerId:myId, name}));
  conn.on('data', handleData);
  document.getElementById('setup').style.display='none';
  document.getElementById('lobby').style.display='block';
  document.getElementById('waitingMsg').innerText = "Waiting for host to start the game...";
};

// Countdown overlay
function startCountdown(callback){
  const overlay = document.createElement('div');
  overlay.id = 'countdownOverlay';
  document.body.appendChild(overlay);
  let count = 3;
  overlay.innerText = count;
  const interval = setInterval(()=>{
    count--;
    if(count>0) overlay.innerText=count;
    else { clearInterval(interval); document.body.removeChild(overlay); callback(); }
  },1000);
}

// Start game display
function startGameForAll(){
  document.getElementById('lobby').style.display='none';
  document.getElementById('game').style.display='block';
  playerHand = players.find(p=>p.id===myId).hand;
  renderHands(); updateTurnInfo();
}

// Host start game
document.getElementById('startGameBtn').onclick = () => {
  if(!isHost) return alert("Only host can start!");
  createDeck();
  players.forEach(p=>{ p.hand=[]; for(let i=0;i<5;i++) p.hand.push(deck.pop()); });
  discardPile.push(deck.pop());
  currentPlayerIndex=0;
  // Send start message to all clients
  connections.forEach(c=>c.send({action:'start', deck, discardPile, players, currentPlayerIndex}));
  startCountdown(startGameForAll);
};

// Start multiplayer game on clients
function startMultiplayerGame(data){
  deck = data.deck;
  discardPile = data.discardPile;
  players = data.players;
  currentPlayerIndex = data.currentPlayerIndex;
  playerHand = players.find(p=>p.id===myId).hand;
  document.getElementById('setup').style.display='none';
  document.getElementById('lobby').style.display='none';
  startCountdown(startGameForAll);
}

// Lobby update
function updateLobby(){
  const list = document.getElementById('playersList'); list.innerHTML='';
  players.forEach(p=>{
    const li = document.createElement('li'); li.innerText = p.name + (p.id===myId?' (You)':'');
    list.appendChild(li);
  });
}

// --- The rest of your previous code for deck, shuffle, drawCard, playCard, renderHands, checkWinner, etc. ---
</script>
</body>
</html>
